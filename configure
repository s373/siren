#!/bin/sh

# Copyright (c) 2011 Tim van der Molen <tbvdm@xs4all.nl>
#
# Permission to use, copy, modify, and distribute this software for any
# purpose with or without fee is hereby granted, provided that the above
# copyright notice and this permission notice appear in all copies.
#
# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
# WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
# MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
# ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
# WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
# ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
# OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.

error()
{
	echo "${0##*/}: $@" >&2
	exit 1
}

header_define()
{
	if [ $# -eq 1 ]; then
		echo "#define $1" >> "$header"
	else
		echo "#define $1 $2" >> "$header"
	fi
}

makefile_assign()
{
	echo "$1=$2" >> "$makefile"
}

makefile_append()
{
	[ "$2" ] && echo "$1+=$2" >> "$makefile"
}

set -e

header=config.h
makefile=config.mk

prefix=/usr/local
bindir_suffix=bin
mandir_suffix=man
plugindir_suffix=lib/siren

have_asprintf=0
have_dirfd=0
have_err=0
have_fgetln=0
have_freebsd_bswap16=0
have_netbsd_bswap16=0
have_netbsd_curses=0
have_openbsd_swap16=0
have_optreset=0
have_queue_h=0
have_resizeterm=0
have_strcasestr=0
have_strlcat=0
have_strlcpy=0
have_strsep=0
have_strtonum=0
have_tree_h=0
have_use_default_colors=0

while [ $# -gt 0 ]; do
	case "$1" in
	debug=*)
		enable_debug="${1#*=}"
		;;

	prefix=*)
		prefix="${1#*=}"
		;;
	bindir=*)
		bindir="${1#*=}"
		;;
	mandir=*)
		mandir="${1#*=}"
		;;
	plugindir=*)
		plugindir="${1#*=}"
		;;

	flac=*)
		enable_flac="${1#*=}"
		;;
	mad=*)
		enable_mad="${1#*=}"
		;;
	sndfile=*)
		enable_sndfile="${1#*=}"
		;;
	vorbis=*)
		enable_vorbis="${1#*=}"
		;;

	ao=*)
		enable_ao="${1#*=}"
		;;
	pulse=*)
		enable_pulse="${1#*=}"
		;;
	sndio=*)
		enable_sndio="${1#*=}"
		;;

	help|-h|--help)
		error "see the INSTALL file for more information"
		;;
	*)
		error "${1%%=*}: invalid option"
	esac
	shift
done

if ! which pkg-config >/dev/null 2>&1; then
	error "cannot run pkg-config"
fi

rm -f "$header" "$makefile"

[ "$CC" ] && makefile_assign CC "$CC"
[ "$CFLAGS" ] && makefile_assign CFLAGS "$CFLAGS"
[ "$CPPFLAGS" ] && makefile_assign CPPFLAGS "$CPPFLAGS"
[ "$LDFLAGS" ] && makefile_assign LDFLAGS "$LDFLAGS"

uname=`uname`
echo configuring for "$uname"

case "$uname" in
FreeBSD)
	have_asprintf=1
	have_dirfd=1
	have_err=1
	have_fgetln=1
	have_freebsd_bswap16=1
	have_optreset=1
	have_resizeterm=1
	have_strcasestr=1
	have_strlcat=1
	have_strlcpy=1
	have_strsep=1
	have_strtonum=1
	have_use_default_colors=1

	[ "$enable_sndio" != yes ] && enable_sndio=no
	;;

Linux)
	have_asprintf=1
	have_dirfd=1
	have_err=1
	have_resizeterm=1
	have_strcasestr=1
	have_strsep=1
	have_use_default_colors=1

	[ "$enable_sndio" != yes ] && enable_sndio=no

	makefile_append CFLAGS -std=c99
	makefile_append CPPFLAGS "-D_POSIX_C_SOURCE=200809L -D_GNU_SOURCE"
	;;

NetBSD)
	have_asprintf=1
	have_dirfd=1
	have_err=1
	have_fgetln=1
	have_netbsd_bswap16=1
	have_netbsd_curses=1
	have_optreset=1
	have_resizeterm=1
	have_strcasestr=1
	have_strlcat=1
	have_strlcpy=1
	have_strsep=1
	have_use_default_colors=1

	[ "$enable_sndio" != yes ] && enable_sndio=no
	;;

OpenBSD)
	have_asprintf=1
	have_dirfd=1
	have_err=1
	have_fgetln=1
	have_openbsd_swap16=1
	have_optreset=1
	have_queue_h=1
	have_resizeterm=1
	have_strcasestr=1
	have_strlcat=1
	have_strlcpy=1
	have_strsep=1
	have_strtonum=1
	have_tree_h=1
	have_use_default_colors=1
	;;

*)
	error "$uname: this system is not supported"
	;;
esac

[ -z "$bindir" ] && bindir="$prefix/$bindir_suffix"
[ -z "$mandir" ] && mandir="$prefix/$mandir_suffix"
[ -z "$plugindir" ] && plugindir="$prefix/$plugindir_suffix"

header_define PLUGIN_DIR "\"$plugindir\""
makefile_assign BINDIR "$bindir"
makefile_assign MANDIR "$mandir"
makefile_assign PLUGINDIR "$plugindir"

if [ "$have_asprintf" -eq 1 ]; then
	header_define HAVE_ASPRINTF
else
	makefile_append SRCS compat/asprintf.c
fi

if [ "$have_dirfd" -eq 1 ]; then
	header_define HAVE_DIRFD
fi

if [ "$have_err" -eq 1 ]; then
	header_define HAVE_ERR
else
	makefile_append SRCS compat/err.c
fi

if [ "$have_fgetln" -eq 1 ]; then
	header_define HAVE_FGETLN
else
	makefile_append SRCS compat/fgetln.c
fi

if [ "$have_freebsd_bswap16" -eq 1 ]; then
	header_define HAVE_FREEBSD_BSWAP16
fi

if [ "$have_netbsd_bswap16" -eq 1 ]; then
	header_define HAVE_NETBSD_BSWAP16
fi

if [ "$have_netbsd_curses" -eq 1 ]; then
	header_define HAVE_NETBSD_CURSES
fi

if [ "$have_openbsd_swap16" -eq 1 ]; then
	header_define HAVE_OPENBSD_SWAP16
fi

if [ "$have_optreset" -eq 1 ]; then
	header_define HAVE_OPTRESET
else
	makefile_append SRCS compat/getopt.c
fi

if [ "$have_queue_h" -eq 1 ]; then
	header_define HAVE_QUEUE_H
fi

if [ "$have_resizeterm" -eq 1 ]; then
	header_define HAVE_RESIZETERM
fi

if [ "$have_strcasestr" -eq 1 ]; then
	header_define HAVE_STRCASESTR
else
	makefile_append SRCS compat/strcasestr.c
fi

if [ "$have_strlcat" -eq 1 ]; then
	header_define HAVE_STRLCAT
else
	makefile_append SRCS compat/strlcat.c
fi

if [ "$have_strlcpy" -eq 1 ]; then
	header_define HAVE_STRLCPY
else
	makefile_append SRCS compat/strlcpy.c
fi

if [ "$have_strsep" -eq 1 ]; then
	header_define HAVE_STRSEP
else
	makefile_append SRCS compat/strsep.c
fi

if [ "$have_strtonum" -eq 1 ]; then
	header_define HAVE_STRTONUM
else
	makefile_append SRCS compat/strtonum.c
fi

if [ "$have_tree_h" -eq 1 ]; then
	header_define HAVE_TREE_H
fi

if [ "$have_use_default_colors" -eq 1 ]; then
	header_define HAVE_USE_DEFAULT_COLORS
fi

if [ "$enable_debug" = yes ]; then
	echo enabling debug build
	header_define DEBUG
	makefile_append CFLAGS -ggdb
fi

if which ncurses5-config >/dev/null 2>&1; then
	makefile_append CPPFLAGS "`ncurses5-config --cflags`"
	makefile_append LDFLAGS "`ncurses5-config --libs`"
else
	makefile_append LDFLAGS -lcurses
fi

if [ "$enable_flac" != no ] && pkg-config flac; then
	echo enabling flac plug-in
	makefile_append IP flac
	makefile_assign CPPFLAGS_flac "`pkg-config --cflags flac`"
	makefile_assign LDFLAGS_flac "`pkg-config --libs flac`"
fi

if [ "$enable_mad" != no ] && pkg-config id3tag mad; then
	echo enabling mad plug-in
	makefile_append IP mad
	makefile_assign CPPFLAGS_mad "`pkg-config --cflags id3tag mad`"
	makefile_assign LDFLAGS_mad "`pkg-config --libs id3tag mad`"
fi

if [ "$enable_sndfile" != no ] && pkg-config sndfile; then
	echo enabling sndfile plug-in
	makefile_append IP sndfile
	makefile_assign CPPFLAGS_sndfile "`pkg-config --cflags sndfile`"
	makefile_assign LDFLAGS_sndfile "`pkg-config --libs sndfile`"

	if pkg-config --atleast-version 1.0.23 sndfile; then
		header_define HAVE_SF_STR_GENRE
		header_define HAVE_SF_STR_TRACKNUMBER
	fi
fi

if [ "$enable_vorbis" != no ] && pkg-config vorbisfile; then
	echo enabling vorbis plug-in
	makefile_append IP vorbis
	makefile_assign CPPFLAGS_vorbis "`pkg-config --cflags vorbisfile`"
	makefile_assign LDFLAGS_vorbis "`pkg-config --libs vorbisfile`"
fi

if [ "$enable_ao" != no ] && pkg-config ao; then
	echo enabling ao plug-in
	makefile_append OP ao
	makefile_assign CPPFLAGS_ao "`pkg-config --cflags ao`"
	makefile_assign LDFLAGS_ao "`pkg-config --libs ao`"

	if pkg-config --atleast-version 1.0.0 ao; then
		header_define HAVE_AO_MATRIX
	fi
fi

if [ "$enable_pulse" != no ] && pkg-config libpulse-simple; then
	echo enabling pulse plug-in
	makefile_append OP pulse
	makefile_append CPPFLAGS_pulse "`pkg-config --cflags libpulse-simple`"
	makefile_append LDFLAGS_pulse "`pkg-config --libs libpulse-simple`"
fi

if [ "$enable_sndio" != no ]; then
	echo enabling sndio plug-in
	makefile_append OP sndio
	makefile_assign LDFLAGS_sndio -lsndio
fi
